<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/default.html}">
	  
	<!-- 사용자 정의 contents -->
	<th:block layout:fragment="customContents">
		<div>
			<span>현재 세팅값</span>
		</div><br>
		<form id="paySetForm" th:action="@{/pay/paySetting}" method="get">
			<div class="card">
				<div class="card-body">
				<table class="table table-bordered" id="payTimeSetTable">
					<tr>
						<th class="col-md-4" style="text-align: center;">월급 지급일</th>
						<th>
							<select class="form-control" id="paySetDate" name="paySetDate">
	                              	<option value="" selected>날짜를 선택하세요</option>
	                              	<option value="1 일">1 일</option>
	                              	<option value="2 일">2 일</option>
	                              	<option value="3 일">3 일</option>
	                              	<option value="4 일">4 일</option>
	                              	<option value="5 일">5 일</option>
	                              	<option value="6 일">6 일</option>
	                              	<option value="7 일">7 일</option>
	                              	<option value="8 일">8 일</option>
	                              	<option value="9 일">9 일</option>
	                              	<option value="10 일">10 일</option>
	                              	<option value="11 일">11 일</option>
	                              	<option value="12 일">12 일</option>
	                              	<option value="13 일">13 일</option>
	                              	<option value="14 일">14 일</option>
	                              	<option value="15 일">15 일</option>
	                              	<option value="16 일">16 일</option>
	                              	<option value="17 일">17 일</option>
	                              	<option value="18 일">18 일</option>
	                              	<option value="19 일">19 일</option>
	                              	<option value="20 일">20 일</option>
	                              	<option value="21 일">21 일</option>
	                              	<option value="22 일">22 일</option>
	                              	<option value="23 일">23 일</option>
	                              	<option value="24 일">24 일</option>
	                              	<option value="25 일">25 일</option>
	                              	<option value="26 일">26 일</option>
	                              	<option value="27 일">27 일</option>
	                              	<option value="28 일">28 일</option>
	                              	<option value="29 일">29 일</option>
	                              	<option value="30 일">30 일</option>
	                              	<option value="31 일">31 일</option>
							</select>
						</th>
					</tr>
					<tr>
						<th class="col-md-4" style="text-align: center;">자동이체 시간</th>
						<th><input type="time" id="paySetTime" name="paySetTime"></th>
					</tr>
				</table>
				</div>
			</div>
			<!-- 추가버튼 클릭시 모달실행하여 db상에있는 기준테이블 선택하여 추가할수 있게하기 -->
			<!-- 기본테이블은 식대만 존재, 추가시 열 추가되게끔 -->
			<div>
				<span>고정지급 급여</span>
				<!-- 추가부분은 모달 > 리스트불러와서 선택 -->
				<button type="button" id="fixedModify" class="btn btn-primary" data-toggle="modal" data-target="#fixedMyModal" style="float: right; margin-bottom: 10px;">항목 수정</button>
			</div><br>
			<div class="card">
				<div class="card-body">
					<table class="table table-bordered" id="fixedPayList">
						<tr>
							<td>선택된 항목이 없습니다.</td>
						</tr>
					</table>
				</div>
			</div>
			<div id="fixedMyModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="fixedMyModalLabel" style="display: none;" aria-hidden="true">
				<div class="modal-dialog">
 					<div class="modal-content">
						<div class="modal-header">
							<h4 class="modal-title" id="fixedMyModalLabel">고정지급 급여 항목 수정</h4>
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						</div>
						<div class="modal-body">
							<span>현재 선택된 항목</span>
							<table class="table table-bordered" id="selectedFixedList">
								<tr>
								</tr>
							</table>
							<select id="setFixedList" class="form-control">
								<option value="" selected>추가항목을 선택하세요</option>
							</select>
						</div>
 						<div class="modal-footer">
							<button type="button" class="btn btn-primary" id="closeFixedModal">확인</button>
						</div>
					</div><!-- /.modal-content -->
				</div><!-- /.modal-dialog -->
			</div>
			<!-- 추가버튼 클릭시 모달실행하여 db상에있는 기준테이블 선택하여 추가할수 있게하기 -->
			<!-- 기본테이블은 소득세만 존재, 추가시 열 추가되게끔 -->
			<div>
				<span>공제액</span>
				<button type="button" id="deductionModify" class="btn btn-primary" data-toggle="modal" data-target="#deduceMyModal" style="float: right; margin-bottom: 10px;">항목 수정</button>
			</div><br>
			<div class="card">
				<div class="card-body">
					<table class="table table-bordered" id="deducePayList">
						<tr>
							<td>선택된 항목이 없습니다.</td>
						</tr>
					</table>
				</div>
			</div>
			<div id="deduceMyModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="deduceMyModalLabel" style="display: none;" aria-hidden="true">
				<div class="modal-dialog">
 					<div class="modal-content">
						<div class="modal-header">
							<h4 class="modal-title" id="deduceMyModalLabel">공제액 항목 수정</h4>
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						</div>
						<div class="modal-body">
							<span>현재 선택된 항목</span>
							<table class="table table-bordered" id="selectedDeduceList">
								<tr>
								</tr>
							</table>
							<select id="setDeduceList" class="form-control">
                              	<option value="" selected>추가항목을 선택하세요</option>
							</select>
						</div>
 						<div class="modal-footer">
							<button type="button"  class="btn btn-primary" id="closeDeduceModal">확인</button>
						</div>
					</div><!-- /.modal-content -->
				</div><!-- /.modal-dialog -->
			</div>
			<div class="col-12" style="display: flex; justify-content: space-around;">
				<button type="button" id="saveModifyBtn" class="btn btn-primary" style="text-align=center;">저장하기</button>
			</div>
		</form>
		
		<th:block layout:fragment="customJs">
			<script type="text/javascript" th:src="@{/dist/js/jquery-3.6.0.min.js}"></script>
        	
        	<script type="text/javascript">
        		
        		/* db에 데이터 전송 컨펌 */
        		$(document).on('click','#saveModifyBtn', function(){
        			var 
        			setDate = $('#paySetDate option:selected').val(),
        			setTime = $('#paySetTime').val(),
        			fixedList = $('#fixedPayList').text(),
        			deduceList = $('#deducePayList').text();
        				
        			if(setDate == 'undefined' || setDate == null || setDate == ''){
		        		alert('날짜를 선택해주세요');
		        		return false;
        			}else if(setTime == 'undefined' || setTime == null || setTime == ''){
        				alert('시간을 선택해주세요');
		        		return false;
		        	} else {
				  		var result = confirm('저장하시겠습니까?');
			            //no
			            console.log(result);
			            if(result) {
			            	$("#paySetForm").submit();
			            }
			        }
        		});
        		
	        	/* 고정지급금, 공제액 db연결 ajax */
	    		$(function(){
	    			var request = 
	    			$.ajax({
					  url: "/pay/fixedSetting",
					  method: "POST",
					  dataType: "json",
					  async: false
					});
					request.done(function(data) {
					  console.log(data[0].fixedAllowName);
					  for(var i=0; i<data.length; i++){
						  var html = '';
						  html += '<option value="' + data[i].fixedAllowName + '">' + data[i].fixedAllowName + '</option>'
						  $('#setFixedList').append(html);
					  }
					  if(data[0].fixedAllowName == '식대'){
						  var request2 =
						  $.ajax({
							  url: "/pay/deductionSetting",
							  method: "POST",
							  dataType: "json",
							});
							request2.done(function(data2) {
							  console.log(data2[0].deductionName);
							  for(var i=0; i<data.length; i++){
								  var html = '';
								  html += '<option value="' + data2[i].deductionName + '">' + data2[i].deductionName + '</option>'
								  $('#setDeduceList').append(html);
							  }
							});
							request2.fail(function( jqXHR, textStatus ) {
							  alert( "Request failed: " + textStatus );
							});
					  };
					});
					request2.fail(function( jqXHR, textStatus ) {
					  alert( "Request failed: " + textStatus );
					});
				});
	    		
				/* 고정지급금 모달에서 항목선택시 추가 */
				$(document).on('change', '#setFixedList', function(){
	    			var html = 	'';
	    			html += '<tr>';
	    			html += '	<td>';
	    			html += '		<span>'; 
	    			html += 			$('#setFixedList option:selected').text(); 
	    			html += '		</span>';
	    			html += '		<a href="javascript:void(0);" class="fDelList"> x</a>'; 
	    			html += '	</td>';
	    			html += '</tr>';
	    			$('#selectedFixedList tbody').append(html);
	    			$('#setFixedList option:selected').remove();
	    		});
				
				/* 공제액 모달에서 항목선택시 추가 */
				$(document).on('change', '#setDeduceList', function(){
	    			var html = 	'';
	    			html += '<tr>';
	    			html += '	<td>';
	    			html += '		<span>'; 
	    			html += 			$('#setDeduceList option:selected').text(); 
	    			html += '		</span>';
	    			html += '		<a href="javascript:void(0);" class="dDelList"> x</a>'; 
	    			html += '	</td>';
	    			html += '</tr>';
	    			$('#selectedDeduceList tbody').append(html);
	    			$('#setDeduceList option:selected').remove();
	    		});
				
				/* 고정지급금 모달에서 선택된 리스트 x 클릭시 삭제 및 리스트로 보내기 */
        		$(document).on('click','.fDelList', function(){
        			var text = $(this).parent().find('span').text();
        			console.log(text);
        			var option = '';
        			option += '<option>';
        			option += 		text;
        			option += '</option>';
        			$('#setFixedList').append(option);
        			$(this).parent().parent().remove();
        		});
        		
        		/* 공제액 모달에서 선택된 리스트 x 클릭시 삭제 및 리스트로 보내기 */
        		$(document).on('click','.dDelList', function(){
        			var text = $(this).parent().find('span').text();
        			console.log(text);
        			var option = '';
        			option += '<option>';
        			option += 		text;
        			option += '</option>';
        			$('#setDeduceList').append(option);
        			$(this).parent().parent().remove();
        		});
        		
        		/* 급여지급 모달 확인버튼 클릭시 창닫고 값전송 */
        		$(document).on('click','#closeFixedModal', function(){
					$('#fixedPayList').empty();
        			var tr = $('#selectedFixedList tr');
        			var td = tr.find('span');
        			var tdArr = new Array();
       				td.each(function(i){
       					tdArr.push(td.eq(i).text());
       					console.log(tdArr);
       				});
       				for(var i=0; i<tdArr.length; i++){
       					var 
       					html = '<tr><td><input type="hidden" class="fixedPayList" name="fixedPayList" value="'+ tdArr[i] +'"/>'+ tdArr[i] +'</td></tr>';
       					$('#fixedPayList').append(html);
       				}
	                $('#fixedMyModal').modal('hide');
        		});
	        		
        	
        		/* 공제액 모달 확인버튼 클릭시 창닫고 값전송 */
        		$(document).on('click','#closeDeduceModal', function(){
					$('#deducePayList').empty();
        			var tr = $('#selectedDeduceList tr');
        			var td = tr.find('span');
        			var tdArr = new Array();
       				td.each(function(i){
       					tdArr.push(td.eq(i).text());
       					console.log(tdArr);
       				});
       				for(var i=0; i<tdArr.length; i++){
       					var 
       					html = '<tr><td><input type="hidden" class="deducePayList" name="deducePayList" value="'+ tdArr[i] +'"/>'+ tdArr[i] +'</td></tr>';
       					
       					$('#deducePayList').append(html);
       				}
	                $('#deduceMyModal').modal('hide');
        		});
        	
			</script>
	
		</th:block>
		
	</th:block>

</html>