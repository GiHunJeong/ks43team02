<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ks43team02.mapper.BoardMapper">
	<resultMap type="NoticeBoard" id="noticeBoardResultMap"						 >
		<id 	column="cp_notice_code" 		property="cpNoticeCode"		 	/>
		<result column="cp_representative_code" property="cpRepresentiveCode"	/>
		<result column="super_admin_id"			property="superAdminId"			/>
		<result column="cp_notice_idx"			property="cpNoticeIdx"			/>
		<result column="notice_title"			property="noticeTitle"			/>
		<result column="notice_contents" 		property="noticeContents"		/>
		<result column="reg_user_name" 			property="regUserName"			/>
		<result column="reg_date" 				property="regDate"				/>
		<result column="modified_date" 			property="modifiedDate"			/>
		<result column="del_date"				property="delDate"				/>
		<result column="view_cnt" 				property="viewCnt"				/>
	</resultMap>
	
	<resultMap type="DepartmentBoard" 			id="departmentBoardResultMap"	 >
		<id		column="department_post_code"	property="departmentPostCode"	/>
		<result column="cp_representative_code"	property="cpRepresentiveCode"	/>
		<result column="super_admin_id"			property="superAdminId"			/>
		<result column="department_idx"			property="departmentIdx"		/>
		<result column="department_cate"		property="departmentCate"		/>
		<result column="emply_id"				property="emplyId"				/>
		<result column="reg_user_name"			property="regUserName"			/>
		<result column="post_title"				property="postTitle"			/>
		<result column="post_contents"			property="postContents"			/>
		<result column="reg_date"				property="regDate"				/>
		<result column="modified_date"			property="modifiedDate"			/>
		<result column="del_date"				property="delDate"				/>
		<result column="viewCnt"				property="viewCnt"				/>
	</resultMap>
	
	<resultMap type="Admin" id="adminResultMap">
		<id column="super_admin_id"							property="superAdminId"/>
		<result column="cp_representative_code"				property="cpRepresentativeCode"/>
		<result column="super_admin_pw"						property="superAdminPw"/>
		<result column="cp_domain"							property="cpDomain"/>
		<result column="specified_domain_address"			property="specifiedDomainAddress"/>
		<result column="reg_date"							property="regDate"/>
		<association property="cpRepresentative"			javaType="CpRepresentative">
			<id column="cp_representative_code"				property="cpRepresentativeCode"/>
			<result column="cp_deposit_status_code"			property="cpDepositStatusCode"/>
			<result column="cp_uniquemply_number"			property="cpUniquemplyNumber"/>
			<result column="cp_name"						property="cpName"/>
			<result column="cp_representativemply_name"		property="cpRepresentativemplyName"/>
			<result column="cp_tel"							property="cpTel"/>
			<result column="cp_registration_number"			property="cpRegistrationNumber"/>
			<result column="cp_addr"						property="cpAddr"/>
			<result column="super_sw_manager"				property="superSwManager"/>
			<result column="reg_date"						property="regDate"/>
		</association>
	</resultMap>
	
	<select id="getSearchDepartmentList" fetchSize="1000" parameterType="String" resultMap="departmentBoardResultMap">
		SELECT
			d.department_post_code,
			d.cp_representative_code,
			d.super_admin_id,
			d.department_idx,
			d.department_cate,
			d.emply_id,
			d.reg_user_name,
			d.post_title,
			d.post_contents,
			d.reg_date,
			d.modified_date,
			d.del_date,
			d.view_cnt
		FROM
			tb_department_post AS d
		<trim prefix="WHERE" prefixOverrides="AND |OR">
			<if test="searchValue != null and searchValue != ''">
				${searchKey} LIKE CONCAT('%', #{searchValue}, '%');
			</if>
		</trim>
	</select>
	
	<select id="getDepartmentDetail" resultMap="departmentBoardResultMap">
		/* 부서별 게시판 게시글 조회 */
		SELECT
			department_post_code,
			cp_representative_code,
			super_admin_id,
			department_idx,
			department_cate,
			emply_id,
			reg_user_name,
			post_title,
			post_contents,
			reg_date,
			modified_date,
			del_date,
			view_cnt
		FROM 
			tb_department_post
		WHERE
			tb_department_post.department_post_code = #{department_post_code};
	</select>
	
	<select id="getDepartmentBoardList" resultMap="departmentBoardResultMap">
		/* 부서별 게시판 목록 조회 */
		SELECT
			d.department_post_code,
			d.cp_representative_code,
			d.super_admin_id,
			d.department_idx,
			d.department_cate,
			d.emply_id,
			d.reg_user_name,
			d.post_title,
			d.post_contents,
			d.reg_date,
			d.modified_date,
			d.del_date,
			d.view_cnt
		FROM
			tb_department_post AS d;
	</select>
	
	<select id="getNoticePaging" parameterType="map" resultType="map">
		SELECT
			a.cp_notice_code			AS cpNoticeCode,           
			a.cp_representative_code	AS cpRepresentiveCode,
			a.super_admin_id			AS superAdminId,
			a.cp_notice_idx				AS cpNoticeIdx,
			a.notice_title				AS noticeTitle,
			a.notice_contents			AS noticeContents,
			a.reg_user_name				AS regUserName,
			a.reg_date					AS regDate,
			a.modified_date				AS modifiedDate,
			a.del_date					AS delDate,
			a.view_cnt					AS viewCnt
		FROM
			tb_all_notice as a
		LIMIT #{startRow}, #{rowPerPage};
	</select>
	
	<select id="getNoticePagingCount" resultType="int">
		SELECT
			COUNT(a.cp_notice_code)
		FROM
			tb_all_notice AS a;
	</select>
	
	<select id="getCpNoticeIdx" resultType="String">
		/* 공지사항 게시글 번호 조회 */
		SELECT
			IFNULL(MAX(cp_notice_idx), 0) + 1 as cpNoticeIdx
		FROM
			tb_all_notice;
	</select>
	
	<insert id="addNotice">
		/* 공지사항 작성 */
		<selectKey resultType="String" keyProperty="cpNoticeCode" order="AFTER">  
	        SELECT
				tbn.cp_notice_code
			FROM
				tb_all_notice AS tbn
			ORDER BY
				tbn.cp_notice_code desc
			LIMIT 1
	    </selectKey>
		INSERT INTO tb_all_notice
			( cp_notice_code
			, cp_representative_code
			, super_admin_id
			, cp_notice_idx
			, notice_title
			, notice_contents
			, reg_user_name
			, reg_date
			, modified_date
			, del_date
			, view_cnt)
		VALUES (
			sf_new_notice_code(),
			 (
				SELECT 
					tb_cp_rep.cp_representative_code
				FROM
					tb_cp_representative 	AS tb_cp_rep
					INNER JOIN
					tb_emply_info_reg		AS tb_emply
					on
					tb_cp_rep.cp_representative_code = tb_emply.cp_representative_code
				WHERE
					tb_emply.emply_id = 'id001@ksmart.or.kr'
			 )
			, (
				SELECT 
					tb_super.super_admin_id
				FROM	
					tb_super_admin 			AS tb_super 
					INNER JOIN
					tb_emply_info_reg		AS tb_emply
					on
						tb_super.super_admin_id = tb_emply.super_admin_id
					WHERE
						tb_emply.emply_id = 'id001@ksmart.or.kr'
				)
			, #{cpNoticeIdx}
			, #{noticeTitle}
			, #{noticeContents}
			, #{regUserName}
			, NOW()
			, NULL
			, NULL
			, #{viewCnt})
		
	</insert>
	
	<update id="noitceViewUpdate" parameterType="int">
		/* 공지사항 게시글 조회수 증가 */ 
		UPDATE 
			tb_all_notice 
	 	SET 
	 		view_cnt = view_cnt + 1 
		WHERE
	 		cp_notice_code = #{cpNoticeCode};
	</update>
	
	<select id="getNoticeDetail" resultMap="noticeBoardResultMap">
		/* 공지사항 게시글 조회 */
		SELECT
			cp_notice_code,
			cp_representative_code,
			super_admin_id,
			cp_notice_idx,
			notice_title,
			notice_contents,
			reg_user_name,
			reg_date,
			modified_date,
			del_date,
			view_cnt
		FROM 
			tb_all_notice
		WHERE
			tb_all_notice.cp_notice_code = #{cp_notice_code};
	</select>
	
	<select id="getNoticeBoardList" resultMap="noticeBoardResultMap">
		/* 공지사항 목록 조회 */
		SELECT
			a.cp_notice_code,
			a.cp_representative_code,
			a.super_admin_id,
			a.cp_notice_idx,
			a.notice_title,
			a.notice_contents,
			a.reg_user_name,
			a.reg_date,
			a.modified_date,
			a.del_date,
			a.view_cnt
		FROM
			tb_all_notice AS a;
	</select>
</mapper>